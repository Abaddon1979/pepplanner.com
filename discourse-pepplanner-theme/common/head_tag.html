<script type="text/discourse-plugin" version="0.8">
const PEPPLANNER_URL = settings.pepplanner_url || 'https://pepplanner.com';

api.onPageChange(() => {
    // Don't re-inject if already present
    if (document.querySelector('.pepplanner-header-icon')) return;

    const headerIcons = document.querySelector('.d-header .icons, .panel.clearfix .header-buttons');
    if (!headerIcons) return;

    // Get current user SSO info
    const currentUser = api.getCurrentUser();
    let ssoParams = '';
    if (currentUser) {
        // Build SSO payload for the iframe
        const payload = btoa(`external_id=${currentUser.id}&username=${currentUser.username}&email=${encodeURIComponent(currentUser.email || '')}&name=${encodeURIComponent(currentUser.name || '')}`);
        ssoParams = `?sso=${payload}`;
    }

    // Create Calculator icon
    const calcBtn = document.createElement('li');
    calcBtn.className = 'header-icon pepplanner-header-icon';
    calcBtn.innerHTML = `
        <a href="#" class="btn btn-flat btn-icon no-text" title="Peptide Calculator">
            <svg class="fa d-icon svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" width="20" height="20">
                <path fill="currentColor" d="M64 0C28.7 0 0 28.7 0 64V448c0 35.3 28.7 64 64 64H320c35.3 0 64-28.7 64-64V64c0-35.3-28.7-64-64-64H64zM96 64H288c17.7 0 32 14.3 32 32v32c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V96c0-17.7 14.3-32 32-32zm32 160a32 32 0 1 1 -64 0 32 32 0 1 1 64 0zM96 352a32 32 0 1 1 0-64 32 32 0 1 1 0 64zM64 416c0-17.7 14.3-32 32-32h96c17.7 0 32 14.3 32 32s-14.3 32-32 32H96c-17.7 0-32-14.3-32-32zM192 256a32 32 0 1 1 0-64 32 32 0 1 1 0 64zm32 64a32 32 0 1 1 -64 0 32 32 0 1 1 64 0zm64-64a32 32 0 1 1 0-64 32 32 0 1 1 0 64zm32 64a32 32 0 1 1 -64 0 32 32 0 1 1 64 0zM288 448a32 32 0 1 1 0-64 32 32 0 1 1 0 64z"/>
            </svg>
        </a>
    `;
    calcBtn.querySelector('a').addEventListener('click', (e) => {
        e.preventDefault();
        openPepplannerModal(PEPPLANNER_URL + '/calculator' + ssoParams, 'Peptide Calculator');
    });

    // Create Calendar icon
    const calBtn = document.createElement('li');
    calBtn.className = 'header-icon pepplanner-header-icon';
    calBtn.innerHTML = `
        <a href="#" class="btn btn-flat btn-icon no-text" title="Pepplanner Calendar">
            <svg class="fa d-icon svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="20" height="20">
                <path fill="currentColor" d="M152 24c0-13.3-10.7-24-24-24s-24 10.7-24 24V64H64C28.7 64 0 92.7 0 128v16 48V448c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V192 144 128c0-35.3-28.7-64-64-64H344V24c0-13.3-10.7-24-24-24s-24 10.7-24 24V64H152V24zM48 192H400V448c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V192z"/>
            </svg>
        </a>
    `;
    calBtn.querySelector('a').addEventListener('click', (e) => {
        e.preventDefault();
        openPepplannerModal(PEPPLANNER_URL + ssoParams, 'Pepplanner Calendar');
    });

    // Insert icons
    headerIcons.prepend(calBtn);
    headerIcons.prepend(calcBtn);
});

// Modal function
function openPepplannerModal(url, title) {
    // Remove existing modal if any
    const existing = document.querySelector('.pepplanner-modal-overlay');
    if (existing) existing.remove();

    // Create modal overlay
    const overlay = document.createElement('div');
    overlay.className = 'pepplanner-modal-overlay';
    overlay.innerHTML = `
        <div class="pepplanner-modal-container">
            <div class="pepplanner-modal-header">
                <span class="pepplanner-modal-title">${title}</span>
                <button class="pepplanner-modal-close">&times;</button>
            </div>
            <iframe src="${url}" class="pepplanner-modal-iframe" frameborder="0"></iframe>
        </div>
    `;

    // Close handlers
    overlay.querySelector('.pepplanner-modal-close').addEventListener('click', () => overlay.remove());
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.remove();
    });

    // ESC to close
    const escHandler = (e) => {
        if (e.key === 'Escape') {
            overlay.remove();
            document.removeEventListener('keydown', escHandler);
        }
    };
    document.addEventListener('keydown', escHandler);

    document.body.appendChild(overlay);
}
</script>